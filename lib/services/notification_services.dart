import 'dart:convert';
import 'dart:developer';
import 'dart:io';
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:flutter/material.dart';
import 'package:flutter_fcm_push_notifications/main.dart';
import 'package:flutter_fcm_push_notifications/screens/payload_screen.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'package:http/http.dart' as http;

class NotificationServices {
  static NotificationServices? _instance;

  NotificationServices._();

  static NotificationServices instance() {
    _instance ??= NotificationServices._();
    return _instance!;
  }

  //................................. requests cloud messaging permission and check status...................................//
  Future<void> requestPermission() async {
    NotificationSettings settings = await FirebaseMessaging.instance
        .requestPermission(
            alert: true,
            announcement: false,
            badge: true,
            carPlay: false,
            criticalAlert: false,
            provisional: false,
            sound: false);
    if (settings.authorizationStatus == AuthorizationStatus.authorized) {
      log('User granted permission');
      // if permission is granted then get token
    } else if (settings.authorizationStatus ==
        AuthorizationStatus.provisional) {
      log('User granted provisional permission');
    } else {
      log('User declined permission');
    }
  }
  //.................................device token is generated by firebase messaging...........................................//
  Future<String?> getToken() async {
    String? deviceToken;
    await FirebaseMessaging.instance.getToken().then((token) async {
      log('my device token : $token');
      deviceToken = token;
    });
    return deviceToken;
  }
  //...................................Initialize flutter local notification services.......................................//
  void initializeNotificationServices() {
    FlutterLocalNotificationsPlugin flutterLocalNotificationsPlugin =
        FlutterLocalNotificationsPlugin();
    // Initialize Notification details
    NotificationDetails getNotificationDetails(String? title, String? body) {
      BigTextStyleInformation bigTextStyleInformation = BigTextStyleInformation(
          body ?? 'No body',
          htmlFormatBigText: true,
          contentTitle: title,
          htmlFormatContentTitle: true);
      AndroidNotificationDetails androidNotificationDetails =
          AndroidNotificationDetails('testapp', 'testapp',
              importance: Importance.high,
              styleInformation: bigTextStyleInformation,
              priority: Priority.high,
              playSound: true);
      NotificationDetails notificationDetails = NotificationDetails(
          android: androidNotificationDetails,
          iOS: const DarwinNotificationDetails(
              presentList: true,
              presentBanner: true,
              presentBadge: true,
              presentAlert: true,
              presentSound: true
          ));
      return notificationDetails;
    }

    // This will be notification icon (Android->app->src->main->res->mipmap->ic_launcher)
    AndroidInitializationSettings androidInitializationSettings =
        const AndroidInitializationSettings('@mipmap/ic_launcher');
    DarwinInitializationSettings darwinInitializationSettings =
        DarwinInitializationSettings(
      requestAlertPermission: true,
      requestBadgePermission: true,
      requestSoundPermission: true,
      onDidReceiveLocalNotification:
          (int id, String? title, String? body, String? payload) async {
        await flutterLocalNotificationsPlugin.show(
          id,
          title,
          body,
          getNotificationDetails(title, body),
          payload: payload,
        );
      },
    );
    InitializationSettings initializationSettings = InitializationSettings(
        android: androidInitializationSettings,
        iOS: darwinInitializationSettings);
    flutterLocalNotificationsPlugin.initialize(
      initializationSettings,
      onDidReceiveNotificationResponse: (details) {
        // handle on notification tap event when notification is on foreground
        log('..........foreground notification tapped..................');
        Navigator.push(
            navigatorKey.currentState!.context,
            MaterialPageRoute(
              builder: (context) => const PayloadScreen(),
            ));
      },
    );
    FirebaseMessaging.onMessage.listen((RemoteMessage message) async {
      log('.......................Foreground Notification Received.......................');
      log('onMessage ${message.notification?.title}/${message.notification?.body}');

      // Only android needs this code to show foreground notification.
      // Apple servers handles it by their own.
      if (Platform.isAndroid) {
        await flutterLocalNotificationsPlugin.show(
          0,
          message.notification?.title,
          message.notification?.body,
          getNotificationDetails(
              message.notification!.title, message.notification!.body),
          payload: message.data['body'],
        );
      }
    });
  }
  //...................set settings in IOS to show foreground notification when app is in foreground....................//
  Future<void> showForegroundNotificationInIOS() async{
    FirebaseMessaging.instance.setForegroundNotificationPresentationOptions(
        alert: true,
        badge: true,
        sound: true
    );
  }

  //............................notification handler when tapped................................................//
  Future<void> notificationHandler(RemoteMessage? message) async {
    if (message == null) {
      log('Notification message is null');
    } else {
      log('Notification handler is called');
      Navigator.push(
          navigatorKey.currentState!.context,
          MaterialPageRoute(
            builder: (context) => const PayloadScreen(),
          ));
    }
  }

  //.........................handle notification tap when app is opened from terminated state...................//
  Future<void> handleNotificationInAppTerminatedState() async {
    await FirebaseMessaging.instance
        .getInitialMessage()
        .then(notificationHandler);
  }
  //.........................................send push notification...................................................//
  Future<void> sendPushNotification(
      {required String title,
      required String body,
      required String payload,
      required String token}) async {
    const String fcmServerKey =
        "AAAA6HJMAH0:APA91bGEyObq-gm4dUKdU-UazfSnxXdWXX2H32NYRSqTZrV4pbupnPOUYbjKl8EvqZby7zw5DvHDyuZNqxrOrQQImWmo9Gzg_lWoKLY1A5kVHM6zM-Bed9b4jwNlP_GJy8JYjPfADqWo";
    try {
      await http.post(Uri.parse('https://fcm.googleapis.com/fcm/send'),
          headers: <String, String>{
            'Content-Type': 'application/json',
            'Authorization': 'key=$fcmServerKey'
          },
          body: jsonEncode(<String, dynamic>{
            'priority': 'high',
            'data': <String, dynamic>{
              'click_action': 'FLUTTER_NOTIFICATION_CLICK',
              'status': 'done',
              'body': payload,
              'title': title,
            },
            'notification': <String, dynamic>{
              'title': title,
              'body': body,
              'android_channel_id': 'testapp'
            },
            'to': token
          }));
    } catch (e) {
      log(e.toString());
    }
  }
}
